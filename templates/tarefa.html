{% extends "base.html" %}
{% load static %}

{% block title %}Tarefas{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Tarefas Diárias</h1>
    </div>

    {% if not has_active_level %}
        <div class="info-box-danger">
            <p>⚠️ **Atenção:** Você precisa ter um nível ativo para realizar tarefas. Faça um <a href="{% url 'deposito' %}" class="link-styled">depósito</a> e compre um nível para começar a ganhar.</p>
        </div>
    {% else %}
        <div class="task-machine-container">
            <div class="machine-screen">
                <p id="task-message">Clique no botão abaixo para trabalhar e gerar seu ganho diário!</p>
            </div>
            <div class="machine-body">
                <div class="machine-light-container">
                    <div class="machine-light"></div>
                    <div class="machine-light"></div>
                    <div class="machine-light"></div>
                </div>
                <div class="machine-dial"></div>
                <button id="work-button" class="work-button">TRABALHAR</button>
            </div>
        </div>

        {# Mensagens do Django podem ser exibidas aqui, se houver #}
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <div class="tasks-info">
            <p><strong>Nível Ativo:</strong> {{ active_level.level.name|default:"Nenhum" }}</p>
            <p><strong>Tarefas diárias restantes:</strong> <span id="tasks-remaining">0</span></p>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const workButton = document.getElementById('work-button');
                const taskMessage = document.getElementById('task-message');
                const tasksRemainingSpan = document.getElementById('tasks-remaining');
                
                // Estes valores devem ser passados do backend.
                // Substitua a linha abaixo por uma variável do Django
                let tasksCompletedToday = {{ tasks_completed_today|default:0 }}; 
                let maxTasks = {{ max_tasks|default:1 }};

                function checkTasksStatus() {
                    if (tasksCompletedToday >= maxTasks) {
                        if (workButton) {
                            workButton.disabled = true;
                            taskMessage.textContent = "Você já completou suas tarefas diárias.";
                        }
                    }
                    if (tasksRemainingSpan) {
                        tasksRemainingSpan.textContent = maxTasks - tasksCompletedToday;
                    }
                }
        
                if (workButton) {
                    workButton.addEventListener('click', function() {
                        if (tasksCompletedToday < maxTasks) {
                            workButton.disabled = true;
                            taskMessage.textContent = "Trabalhando... aguarde.";

                            // Fazer uma requisição AJAX para o backend aqui
                            // Exemplo usando fetch API
                            fetch("{% url 'process_task' %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}' // Necessário para POST requests no Django
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    tasksCompletedToday++;
                                    taskMessage.textContent = `Tarefa concluída! Ganho diário: $ ${data.daily_gain}.`;
                                    // Atualizar o saldo do usuário na página se necessário
                                } else {
                                    taskMessage.textContent = data.message || "Ocorreu um erro ao proces$ a tarefa.";
                                }
                                checkTasksStatus();
                                workButton.disabled = false; // Reativar o botão se houver erro ou para a próxima tarefa
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                taskMessage.textContent = "Erro na comunicação com o servidor.";
                                workButton.disabled = false;
                            });
                        }
                    });
                }
                checkTasksStatus();
            });
        </script>
    {% endif %}
</div>

<style>
    .page-container {
        padding: 10px;
    }
    .page-header {
        text-align: center;
        padding: 15px 0;
        background-color: #00004d;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .page-header h1 {
        color: #4CAF50;
        font-family: 'Arial', sans-serif;
    }
    .info-box-danger {
        background-color: #5d0f1f;
        border-left: 5px solid #ff4444;
        padding: 15px;
        border-radius: 8px;
        margin: 20px auto;
        max-width: 400px;
        line-height: 1.6;
        color: #e0e0e0;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .link-styled {
        color: #87CEEB;
        text-decoration: underline;
    }
    .task-machine-container {
        background-color: #0d1a2f;
        padding: 20px;
        border-radius: 15px;
        margin: 20px auto;
        max-width: 350px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        text-align: center;
        border: 2px solid #1a3250;
    }
    .machine-screen {
        background-color: #00002d;
        color: #fff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }
    .machine-screen p {
        margin: 0;
        font-size: 1.1rem;
        font-family: 'Courier New', Courier, monospace;
    }
    .machine-body {
        position: relative;
        padding: 10px;
    }
    .machine-light-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
    }
    .machine-light {
        width: 15px;
        height: 15px;
        background-color: #ff4444;
        border-radius: 50%;
        box-shadow: 0 0 10px #ff4444;
        animation: blink 1s infinite alternate;
    }
    .machine-light:nth-child(2) { animation-delay: 0.3s; }
    .machine-light:nth-child(3) { animation-delay: 0.6s; }

    @keyframes blink {
        from { opacity: 0.5; }
        to { opacity: 1; }
    }
    .work-button {
        display: block;
        width: 80%;
        padding: 15px;
        margin: 0 auto;
        background-color: #4CAF50;
        color: #fff;
        border: none;
        border-radius: 50px;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        transition: transform 0.2s, box-shadow 0.4s;
    }
    .work-button:hover {
        transform: scale(1.05);
        box-shadow: 0 0 25px rgba(76, 175, 80, 0.8);
    }
    .work-button:disabled {
        background-color: #757575;
        cursor: not-allowed;
        box-shadow: none;
    }
    .tasks-info {
        background-color: #0d1a2f;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        max-width: 400px;
        margin: 20px auto;
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    .tasks-info p {
        color: #fff;
        margin: 5px 0;
        font-family: 'Arial', sans-serif;
    }
    .tasks-info strong {
        color: #87CEEB;
    }
</style>
{% endblock %}
